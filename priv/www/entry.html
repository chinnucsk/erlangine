<div class=toolbar>
    <a id=entSave class=gbutton>Save</a>
    <a id=entSaveTemplate class=gbutton>Save as template</a>
    <a id=entNew class=gbutton>New</a>
    <label for=entType>as</label>
    <select id=entType></select>
</div>
<div id=entInfo>
    <input id=entId type=hidden />
    <input id=entRev type=hidden />
    <label for=entOptType>Add field named</label>
    <input id=entNewFieldName type=text />
    <label for=entOptType>of type</label>
    <select id=entFieldTypes></select>
    <a id=entFieldAdd class=rhint title="Add field">+</a>
    <div class=fieldlistscroll>
        <table class=fieldlist cellspacing=0>
            <thead><tr>
                <th class=fldctl-td></th>
                <th class=fieldname>Field</th>
                <th class=fieldtype>Type</th>
                <th class=fieldvalue></th>
                <th>Value</th>
            </tr></thead>
            <tbody id=entFields></tbody>
        </table>
    </div>
</div>
<div id=entEditorView></div>
<div id=entEditorText></div>

<script>

function prepEntEditor(){
    var json = {
        "module": "entry",
        "action": "entry_types",
        "data": {}
    }
    ajax(json, "/enge");
}

function cbEntryTypes(json){
    replaceChildNodes('entType', map(function(Name){return OPTION({'value': Name}, Name)},
                                    json.reply.entry));
    replaceChildNodes('entFieldTypes', map(function(Name){return OPTION({'value': Name}, Name)},
                                           json.reply.fields))
}

function doApplyTemplate(){
    var json = {
        "module": "entry",
        "action": "template",
        "data": $('entType').value
    }
    ajax(json, "/enge");
}

function composeTR(Field){
    var del_fld = A({'class': 'bdelete'});
    connect (del_fld, 'onclick', doDeleteField);
    var val = TD({'class': 'fldvalue-td'}, Field.value);
    connect(val, 'ondblclick', doEditField);
    return TR(null, TD({'class': 'fldctl-td'}, del_fld),
                    TD({'class': 'fieldname'}, Field.name),
                    TD({'class': 'fieldtype'}, Field.type),
                    TD({'class': 'fieldvalue'}, Field.value),
                    val)
}

function cbEntTemplate(json){
    disconnectAllTo(doEditField);
    disconnectAllTo(doFieldFix);
    replaceChildNodes('entFields', map(composeTR, json.reply.fields));
}

function findField(Name){
    var matched = null;
    map(function(item){if(item.innerHTML == Name)matched = item; return null},
        findChildElements($('entFields'), ['.fieldname']));
    return matched
}

function doAddField(){
    var Name = $('entNewFieldName').value;
    if(Name == ""){
        statusM("Name for new field is not set!");
        return
    }
    var matched = findField(Name);
    if(matched){
        statusM('Edit existing field');
        signal(findChildElements(matched.parentNode, ['.fldvalue-td'])[0],
               'ondblclick')
    }else{
        var tr = composeTR({'name': Name, 'type': $('entFieldTypes').value});
        appendChildNodes('entFields', tr)
        signal(findChildElements(tr, ['.fldvalue-td'])[0],
               'ondblclick')
    }
}

function doDeleteField(){
    disconnectAll(this);
    removeElement(this.parentNode.parentNode)
}

function FieldValue(item){
    return findChildElements(item.parentNode, ['.fieldvalue'])[0]
}

EditField = null;

function doEditField(){
     if(EditField) return;
     EditField = INPUT({'type': 'text', 'value': dequote(FieldValue(this).innerHTML)});
     connect(EditField, 'onblur', doFieldFix);
     connect(EditField, 'onkeydown', escRevertField);
     replaceChildNodes(this, EditField)
     EditField.focus()
}

function doFieldFix(){
     disconnectAll(EditField);
     FieldValue(EditField.parentNode).innerHTML = quote(EditField.value);
     EditField.parentNode.innerHTML = quote(EditField.value);
     EditField = null;
}

function doFieldRevert(){
     disconnectAll(EditField)
     EditField.parentNode.innerHTML = FieldValue(EditField.parentNode).innerHTML;
     EditFieldValue = "";
     EditField = null;
}

function escRevertField(ev){
    if(ev.key().code==27) doFieldRevert();
}

function doNewEntry(){
    $('entId').value="";
    $('entRev').value="";
    $('entFields').innerHTML="";
}

function cbEditEntry(json){
    statusM("Edit entry: " + json.reply._id + " : " + json.reply._rev);
    $('entId').value = json.reply._id,
    $('entRev').value = json.reply._rev,
    signal('entEditor_tab', 'onclick');
}

function doSave(){
    var json = {
	"module": "entry",
	"action": "save",
	"data": {
	    "title": $('entTitle').value,
	    "id": $('entId').value,
	    "rev": $('entRev').value,
	    "anno": $('entAnnotation').value,
            "text": text
	}
    }
    ajax(json, "/enge");
}

function cbEntSaved(json){
    log("entry saved: " + JSON.stringify(json))
    statusM(json.reply.action);
    $('entId').value = json.reply.id;
    $('entRev').value = json.reply.rev;
}

connect('entSave', 'onclick', doSave);
connect('entFieldAdd', 'onclick', doAddField);
connect('entNew', 'onclick', doApplyTemplate);

connect(xapi, 'entry:save-ok', cbEntSaved);
connect(xapi, 'entry:entry_types-ok', cbEntryTypes);
connect(xapi, 'entry:template-ok', cbEntTemplate);

connect(xapi, 'logged', prepEntEditor);
</script>
