<div class=toolbar>
    <a id="docSearch" class=button>Search</a>
    <a id="docDelete" class=gbutton>Delete</a>
</div>
<table id="docSelect" cellspacing=1>
    <thead><tr><th>x</th><th>Name</th><th>Date</th></tr></thead>
    <tbody id="docSearchResult"> </tbody>
</table>

<script>

function doSearchDocs(){
    var json = {
        "module": "doc",
        "action": "search"
    }
    ajax(json, "/enge");
};

function doDeleteDocs(){
    var doclist = map(
        function(elt){ return({"id": elt.name, "rev": elt.value}) },
        ifilter(
            function(elt){return(elt.checked)},
            findChildElements($('docSelect'), ['.docRowCheck'])));
    log("to delete: " + JSON.stringify(doclist));
    var json = {
        "module": "doc",
        "action": "bulk_delete",
        "data": doclist
    }
    ajax(json, "/enge");
};

function doDocView(what){
    var idd = what.target().id.split(":",3);
    var json = {
    "module": "doc",
    "action": "doc_get",
    "event": "show_doc",
    "data": {
        "id": idd[1],
        "rev": idd[2]
    }
    }
    ajax(json, "/enge");
}

function composeDocRow(doc){
    var Title = TD(null, [SPAN({'id': 'docs:' + doc._id + ':' + doc._rev,
                                'title': doc.anno},
                               doc.title)]);
    connect(Title, 'onclick', doDocView);
    return TR({'class': 'docSearchResultRow'},
              [TD(null, INPUT({'type': 'checkbox',
                               'class': 'docRowCheck',
                               'name': doc._id,
                               'value': doc._rev})),
               Title,
               TD(null, doc.date.D + "." + doc.date.M + "." + doc.date.Y)
              ]);
}

function cbSearchResult(json){
    log("search results: " + JSON.stringify(json));
    statusM(json.event);
    disconnectAllTo(doDocView);
    var tab = map(function(doc){return composeDocRow(doc)},
                  json.reply);
    replaceChildNodes('docSearchResult', tab)
}

connect('docSearch', 'onclick', doSearchDocs);
connect('docDelete', 'onclick', doDeleteDocs);

connect(xapi, 'doc:search-ok', cbSearchResult);
connect(xapi, 'doc:bulk_delete-ok', doSearchDocs);

connect(xapi, 'logged', doSearchDocs);
</script>
