<div class=toolbar id=entCreate>
    <a id=entNew class=gbutton>Новая запись</a>
    <select id=entType></select>
</div>
<div id=entInfo>
    <input id=entId type=hidden />
    <input id=entRev type=hidden />
    <div class=toolbar>
        <a id=entSave class=gbutton>Сохранить</a>
        <a id=entSaveTemplate class=gbutton>Сохранить как шаблон</a>
        <a class=button id=entFieldAdd>Добавить полe</a>
        <label for=entNewFieldName>имя:</label>
        <input id=entNewFieldName type=text />
        <label for=entFieldTypes>значение:</label>
        <input id=entNewFieldValue type=text />
        <a id=entCancel class=button>Отмена</a>
    </div>
    <div class=fieldscroll>
        <table class=fieldlist cellspacing=0>
            <thead><tr>
                <th class=fld-ctl></th>
                <th class=fld-name>Поле</th>
                <th class=fld-valctl></th>
                <th class=fld-values>Значение</th>
            </tr></thead>
            <tbody id=entFields></tbody>
        </table>
    </div>
</div>
<div id=entEditorView></div>
<div id=entEditorText></div>

<script>

function prepEntEditor(){
    var json = {
        "module": "entry",
        "action": "entry_templates",
        "data": {}
    }
    ajax(json, "/enge");
}

function cbEntryTemplates(json){
    replaceChildNodes('entType', map(function(Name){return OPTION({'value': Name}, Name)},
                                    json.reply.entry));
}

function cbValueTypes(json){
    var apply = A({'class': 'bapply'});
    connect(apply, 'onclick', doValueTypeFix);
    var cancel = A({'class': 'bcancel'});
    connect(cancel, 'onclick', doValueTypeCancel);
    EntTypeSelector =
        TD({'id': 'entTypeSelector'},
            SELECT({'id': 'valuetype-sel'},
                map(function(Name){return OPTION({'value': Name}, Name)},
                    json.reply.types)),
            apply,
            cancel);
}

function doValueTypeFix(){
    var val = $('valuetype-sel').value;
    var tab = this.parentNode.parentNode.parentNode;
    removeElement(this.parentNode.parentNode);
    appendChildNodes(tab, composeValue({'type': val, 'value': ''}))
}

function doValueTypeCancel(){
    removeElement(this.parentNode.parentNode)
}

function doApplyTemplate(){
    var json = {
        "module": "entry",
        "action": "template",
        "data": $('entType').value
    }
    ajax(json, "/enge");
    json = {
        "module": "entry",
        "action": "value_types",
        "data": $('entType').value
    }
    ajax(json, "/enge");
}

function composeValue(Value){
    var del_val = A({'class': 'rhint'}, 'x');
    connect (del_val, 'onclick', doDeleteValue);
    return TR(null,
               TD({'class': 'val-ctl'}, del_val),
               TD({'class': 'val-value'},
                   SPAN({'class': 'valuename'}, Value.type),
                   SPAN(null, Value.value)))
}

function composeTR(Field){
    var del_fld = A({'class': 'bdelete'});
    connect (del_fld, 'onclick', doDeleteField);
    var add_val = A({'class': 'rhint'}, '+');
    connect (add_val, 'onclick', doAddValue);
    return TR(null, TD({'class': 'fld-ctl'}, del_fld),
                    TD({'class': 'fld-name'}, Field.name),
                    TD({'class': 'fld-valctl'}, add_val),
                    TD({'class': 'fld-values'},
                        TABLE({'class': 'valuelist'}, TBODY({'class': 'val-tbody'},
                            map(composeValue, Field.values)))))
}

function doAddValue(){
    appendChildNodes(findChildElements(this.parentNode.parentNode, ['.val-tbody'])[0], TR(null, TD(), EntTypeSelector));
    $('valuetype-sel').focus();
}

function cbEntTemplate(json){
    disconnectAllTo(doEditField);
    disconnectAllTo(doFieldFix);
    replaceChildNodes('entFields', map(composeTR, json.reply.fields));
    hideElement('entCreate');
    showElement('entInfo')
}

function doCancel(){
    disconnectAllTo(doEditField);
    disconnectAllTo(doFieldFix);
    replaceChildNodes('entFields', TR(null));
    showElement('entCreate');
    hideElement('entInfo')
}

function findField(Name){
    var matched = null;
    map(function(item){if(item.innerHTML == Name)matched = item; return null},
        findChildElements($('entFields'), ['.fld-name']));
    return matched
}

function doAddField(){
    var Name = $('entNewFieldName').value;
    if(Name == ""){
        statusM("Name for new field is not set!");
        return
    }
    var matched = findField(Name);
    if(matched){
        statusM('Please edit existing field');
        matched.focus();
    }else{
        var val = $('entNewFieldValue');
        var values = [];
        if(val != "") values = [{'default': val}];
        var tr = composeTR({'name': Name, 'values': values});
        appendChildNodes('entFields', tr)
        // XXX if not val, open new value dialog (addValue click)
    }
}

function doDeleteField(){
    disconnectAll(this);
    removeElement(this.parentNode.parentNode)
}

function doDeleteValue(){
    disconnectAll(this);
    removeElement(this.parentNode.parentNode)
}

// return TD
function FieldValue(item){
    return findChildElements(item.parentNode, ['.fieldvalue'])[0]
}

// return text
function FieldType(item){
    return findChildElements(item.parentNode, ['.fieldvalue'])[0].innerHTML
}

/* ********************
display field by value
    DisplayField(type, value) -- DOM
edit field by value - make input construct
    FieldEditor(type, value) -- DOM
callbacks calls (after cleanup):
    doFieldFix(value) - save and redisplay
    doFieldRevert() - simple redisplay the old value
*/

function DisplayField(type, value){
    return value
}

function FieldEditor(type, value){
    var ed = INPUT({'type': 'text', 'value': value});
    connect(ed, 'onblur', sigFieldFix);
    connect(ed, 'onkeydown', sigFieldKeys);
    return ed
}

function sigFieldFix(ev){
    disconnectAll(EditField);
    doFieldFix(EditField.value)
}

function sigFieldKeys(ev){
    if(ev.key().code==27){
        disconnectAll(EditField);
        doFieldRevert()
    }
}

/* ******************** */

EditField = null;

function doEditField(){
    if(EditField) return;
    EditField = FieldEditor(FieldType(this), dequote(FieldValue(this).innerHTML));
    replaceChildNodes(this, EditField)
    EditField.focus()
}

function doFieldFix(value){
    var qv = quote(value);
    FieldValue(EditField.parentNode).innerHTML = qv;
    replaceChildNodes(EditField.parentNode,
                      DisplayField(FieldType(EditField.parentNode),
                                   qv));
    EditField = null;
}

function doFieldRevert(){
    replaceChildNodes(EditField.parentNode,
                      DisplayField(FieldType(EditField.parentNode),
                                   FieldValue(EditField.parentNode).innerHTML));
    EditField = null;
}

function doNewEntry(){
    $('entId').value="";
    $('entRev').value="";
    $('entFields').innerHTML="";
}

function cbEditEntry(json){
    statusM("Edit entry: " + json.reply._id + " : " + json.reply._rev);
    $('entId').value = json.reply._id,
    $('entRev').value = json.reply._rev,
    signal('entEditor_tab', 'onclick');
}

function doSave(){
    var json = {
	"module": "entry",
	"action": "save",
	"data": {
	    "title": $('entTitle').value,
	    "id": $('entId').value,
	    "rev": $('entRev').value,
	    "anno": $('entAnnotation').value,
            "text": text
	}
    }
    ajax(json, "/enge");
}

function cbEntSaved(json){
    log("entry saved: " + JSON.stringify(json))
    statusM(json.reply.action);
    $('entId').value = json.reply.id;
    $('entRev').value = json.reply.rev;
}

connect('entSave', 'onclick', doSave);
connect('entCancel', 'onclick', doCancel);
connect('entNew', 'onclick', doApplyTemplate);
connect('entFieldAdd', 'onclick', doAddField);

connect(xapi, 'entry:entry_templates-ok', cbEntryTemplates);
connect(xapi, 'entry:value_types-ok', cbValueTypes);
connect(xapi, 'entry:template-ok', cbEntTemplate);
connect(xapi, 'entry:save-ok', cbEntSaved);

connect(xapi, 'logged', prepEntEditor);
</script>
