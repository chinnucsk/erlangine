<div class=toolbar id=entCreate>
    <a id=entNew class=gbutton title="Новая запись по шаблону">Новая запись</a>
    <select id=entTemplate></select>
</div>
<div id=entInfo>
    <input id=entId type=hidden />
    <input id=entRev type=hidden />
    <div class=toolbar>
        <a id=entSave class=gbutton title="Сохранить запись">Сохранить</a>
        <input id=entCreateNew type=checkbox checked=false />
        <label for=entCreateNew>как новую запись</label>
        <!-- a id=entDouble class=gbutton title="Сделать копию записи">Дублировать</a-->
        <a id=entCancel class=button>Отмена</a>
    </div>
    <div class=toolbar>
        <a class=button id=entFieldAdd>Добавить полe</a>
        <label for=entNewFieldName>имя:</label>
        <input id=entNewFieldName type=text />
        <label for=entNewFieldValue>значение:</label>
        <input id=entNewFieldValue type=text />
    </div>
    <div class=fieldscroll>
        <div id=entFields></div>
    </div>
</div>

<script>

function ClearEntry(){
    // XXX partial list
    map(disconnectAllTo,
        [doEditValue, doValueNameFix, doValueNameCancel]);
    $('entId').value="";
    $('entRev').value="";
    $('entCreateNew').checked = false;
    $('entFields').innerHTML=""
}

function requestTemplates(){
    var json = {
        "module": "entry",
        "action": "entry_templates",
        "data": {}
    }
    ajax(json, "/enge")
}

function cbEntryTemplates(json){
    replaceChildNodes('entTemplate', map(function(tpl){return OPTION({'value': tpl.id}, tpl.key + " : " + tpl.value.type)},
                                    json.reply))
}

function doApplyTemplate(){
    statusM("requesting new entry...")
    var json = {
        "module": "entry",
        "action": "template",
        "data": $('entTemplate').value
    }
    ajax(json, "/enge");
    statusM("wait for new entry...")
}

function composeValue(Value){
    var del_val = A({'class': 'rhint', 'title': "удалить значение"}, 'x');
    connect (del_val, 'onclick', doDeleteValue);
    var vis = DIV({'class': 'valuevis'});
    DisplayValue(vis, Value.type, Value.value);
    var vnamehidden = "";
    if(Value.name == 'Текст') vnamehidden = ' hidden';
    val = DIV({'class': 'val-value'},
              SPAN(null, del_val),
              SPAN({'class': 'valuename' + vnamehidden}, Value.name),
              SPAN({'class': 'valuetype'}, Value.type),
              INPUT({'class': 'valueval', 'type': 'hidden', 'value': Value.value}),
              vis);
    connect(val, 'ondblclick', doEditValue);
    new Draggable(val, {'revert': true});
    new Droppable(val, {'hoverclass': 'val-value-ondrop',
                        'accept': ['val-value'],
                        'ondrop': function(drg, drp){
                                      removeElement(drg);
                                      insertSiblingNodesBefore(drp, drg)
                                  }});
    return val
}

function composeTR(Field){
    var del_fld = A({'class': 'bdelete'});
    connect (del_fld, 'onclick', doDeleteField);
    var add_val = A({'class': 'rhint add-val', 'title': "добавить значение"}, '+');
    connect (add_val, 'onclick', doAddValue);
    var div = DIV({'class': 'fldtr'},
              SPAN(null, del_fld, add_val),
              SPAN({'class': 'fld-name'}, Field.name),
              map(composeValue, Field.values));
    new Draggable(div, {'revert': true});
    new Droppable(div, {'hoverclass': 'fldtr-ondrop',
                        'accept': ['fldtr', 'val-value'],
                        'ondrop': function(drg, drp){
                                      if(hasElementClass(drg, 'fldtr')){
                                          removeElement(drg);
                                          insertSiblingNodesBefore(drp, drg)
                                      }else if(!isChildNode(drg, drp)){
                                              removeElement(drg);
                                              appendChildNodes(drp, drg)
                                      }
                                  }});
    return div
}

function EntryTypes(){
    var ty = filter(function(elt){return (elt.innerHTML == "Тип")},
                    findChildElements($('entFields'), ['.fld-name']));
    if(ty.length > 0){
        return map(function(elt){return elt.value},
                   findChildElements(ty[0].parentNode, ['.valueval']));
    } else return []
}

ValueSelector = false;

function doAddValue(){
    if (InEditor()) return;
    ValueSelector = this.parentNode.parentNode;
    json = {
        "module": "entry",
        "action": "value_names",
        "data": {'type': EntryTypes(),
                 'field': findChildElements(ValueSelector, ['.fld-name'])[0].innerHTML
                }
    }
    ajax(json, "/enge")
}

function cbValueNames(json){
    var apply = A({'class': 'bapply'});
    connect(apply, 'onclick', doValueNameFix);
    var cancel = A({'class': 'bcancel'});
    connect(cancel, 'onclick', doValueNameCancel);
    var sel = SELECT({'id': 'value-sel'},
                     map(function(val){return OPTION({'value': val.name + ',' + val.type}, val.name)},
                         json.reply.top),
                     OPTION({'value': "separator"}, ""),
                     map(function(val){return OPTION({'value': val.name + ',' + val.type}, val.name)},
                         json.reply.all));
    connect(sel, 'onkeydown', sigValueNameKeys);
    appendChildNodes(ValueSelector,
                     DIV({'id': 'entValueSelector'}, cancel, apply, sel));
    $('value-sel').focus()
}

function sigValueNameKeys(ev){
    if(ev.key().code==27){
        disconnectAll(EditValue);
        doValueNameCancel()
    } else if(ev.key().code==13){
        disconnectAll(EditValue);
        doValueNameFix()
    }
}

function doValueNameFix(){
    if($('value-sel').value != "separator"){
        var val = $('value-sel').value.split(',');
        var elt = $('entValueSelector').parentNode;
        removeElement('entValueSelector');
        valrow = composeValue({'name': val[0], 'type': val[1], 'value': ''});
        appendChildNodes(elt, valrow);
        ValueSelector = false;
        signal(valrow, 'ondblclick')
    }else doValueNameCancel()
}

function doValueNameCancel(){
    removeElement('entValueSelector');
    ValueSelector = false;
}

function cbEntTemplate(json){
    ClearEntry();
    replaceChildNodes('entFields', map(composeTR, json.reply.fields));
    // removing type = "Template"
    // XXX can be done more cute by simply removing the first element of Type
    var ty = filter(function(elt){return (elt.innerHTML == "Тип")},
                       findChildElements($('entFields'), ['.fld-name']));
    if(ty.length > 0){
        var tpl = filter(function(elt){return (elt.value == "Шаблон")},
                          findChildElements(ty[0].parentNode, ['.valueval']));
        // XXX must check for field.name == "Тип"
        if(tpl.length > 0) removeElement(tpl[0].parentNode);
    }
    hideElement('entCreate');
    showElement('entInfo');
    statusM("ok")
}

function cbEntEdit(json){
    statusM("Edit entry: " + json.reply._id + " : " + json.reply._rev);
    ClearEntry();
    replaceChildNodes('entFields', map(composeTR, json.reply.fields));
    hideElement('entCreate');
    showElement('entInfo');
    $('entId').value = json.reply._id;
    $('entRev').value = json.reply._rev;
    signal('entEditor_tab', 'onclick');
}

doNewEntryFromSelector = function(){
    doCancel();
    signal('entEditor_tab', 'onclick');
}

function doCancel(){
    // XXX _partial_ list for disconnect
    ClearEntry();
    requestTemplates();
    showElement('entCreate');
    hideElement('entInfo')
}

function findField(Name){
    var matched = null;
    map(function(item){if(item.innerHTML == Name)matched = item; return null},
        findChildElements($('entFields'), ['.fld-name']));
    return matched
}

function doAddField(){
    if (InEditor()) return;
    var Name = $('entNewFieldName').value;
    if(Name == ""){
        statusM("Name for new field is not set!");
        return
    }
    var matched = findField(Name);
    if(matched){
        statusM('Please edit existing field')
    }else{
        var val = $('entNewFieldValue').value;
        var values = [];
        if(val != ""){
            values = [{'type': 'text', 'name': "Текст", 'value': val}];
        }
        var tr = composeTR({'name': Name, 'values': values});
        appendChildNodes('entFields', tr);
        if(val == "") signal(findChildElements(tr, ['.add-val'])[0], 'onclick')
    }
}

function InEditor(){
    if(EditValue || ValueSelector){
        statusM("please close value editor first");
        return true
    }
}

function doDeleteField(){
    if (InEditor()) return;
    disconnectAll(this);
    removeElement(this.parentNode.parentNode)
}

function doDeleteValue(){
    if (InEditor()) return;
    disconnectAll(this);
    removeElement(this.parentNode.parentNode)
}

/* ********************
display field by value
    DisplayValue(vis, type, value) -- DOM element, class=valuevis
edit field by value - make input construct
    ValueEditor(elt, type, value) -- DOM
callbacks calls (after cleanup):
    doFieldFix(value) - save and redisplay
    doFieldRevert() - simple redisplay the old value
*/

/*
   If string contains no angle brackets - it is a string, otherwise - text
   If string - Esc - revert; Enter - fix; Tab - open text editor
*/
function ValueEditorStringOrText(elt, type, value){
    if(dequote(value).split("<",2).length > 1) ValueEditorText(elt, type, value)
    else ValueEditorString(elt, type, value)
}

function ValueEditorString(elt, type, value){
    var ed = INPUT({'type': 'text', 'id': 'entEditorInput', 'value': dequote(value)});
    connect(ed, 'onkeydown', sigValueKeys);
    var txt = SPAN({'class': 'rhint'}, "[текст]");
    connect(txt, 'onclick', swapRichEditor);
    var VE = DIV({'class': 'valuevis'}, ed, txt);
    swapDOM(elt, VE);
    ed.focus();
    EditValue = VE
}

function swapRichEditor(){
    disconnectAll(EditValue);
    var val = EditValue.parentNode;
    var value = $('entEditorInput').value;
    ValueEditorText(ValueVis(val), ValueType(val), quote(value))
}

function sigValueKeys(ev){
    if(ev.key().code==27){
        disconnectAll(EditValue);
        doValueRevertString()
    } else if(ev.key().code==13){
        disconnectAll(EditValue);
        doValueFixString();
    } else if(ev.key().code==9){
        swapRichEditor()
    }
}

function doValueFixString(){
    var value = $('entEditorInput').value;
    disconnectAll($('entEditorInput'));
    var qv = quote(value);
    // XXX wrong when only one <p/> follows <ul> etc tags
    ValueValue(EditValue.parentNode).value = qv;
    DisplayValue(EditValue, 'string', qv);
    EditValue = null
}

// XXX tautology for all types
function doValueRevertString(){
    disconnectAll($('entEditorInput'));
    DisplayValue(EditValue,
                 'string',
                 ValueValue(EditValue.parentNode).value);
    EditValue = null
}


function DisplayValueText(vis, type, value){
    vis.innerHTML = dequote(value)
}

function ValueEditorText(elt, type, value){
    var apply = A({'class': 'bapply'});
    connect(apply, 'onclick', doValueFixText);
    var revert = A({'class': 'bcancel'});
    connect(revert, 'onclick', doValueRevertText);
    var ed = DIV({'id': 'entEditorText'});
    var VE = DIV({'class': 'valuevis'}, revert, apply, ed);
    swapDOM(elt, VE);
    setupEditor('entEditorText', dequote(value));
    EditValue = VE
}

function doValueFixText(){
    var value = tinyMCE.get('entEditorText').getContent();
    // XXX wrong when only one <p/> follows <ul> etc tags
    if(value.split("<p>").length <= 2) value = value.replace('<p>', '').replace('</p>', '');
    var qv = quote(value);
    ValueValue(EditValue.parentNode).value = qv;
    DisplayValue(EditValue, 'text', qv);
    EditValue = null
}

function doValueRevertText(){
    DisplayValue(EditValue,
                 'text',
                 ValueValue(EditValue.parentNode).value);
    EditValue = null
}

// XXX ask confirmation
function doValueShotScore5(elt, score){
    ev = elt.parentNode.parentNode.parentNode;

    var apply = A({'class': 'bapply'});
    connect(apply, 'onclick', function(){doValueFixScore5(score)});
    var revert = A({'class': 'bcancel'});
    connect(revert, 'onclick', doValueRevertScore5);
    var VE = SPAN({'class': 'valuevis'},
                 revert, apply,
                 SPAN({'class': 'valueask'}, "Установить оценку " + score + "?"));
    swapDOM(ev, VE);
    EditValue = VE
}

function doValueFixScore5(score){
    ValueValue(EditValue.parentNode).value = score;
    DisplayValue(EditValue, 'score5', score);
    EditValue = null
}

function doValueRevertScore5(){
    DisplayValue(EditValue,
                 'score5',
                 ValueValue(EditValue.parentNode).value);
    EditValue = null
}

function DisplayValueScore5(vis, type, value){
    var score = UL({'class': 'star-rating inline-rating small-star'},
                   LI({'class': 'current-rating', 'style': 'width:' + value * 20 + '%'}, value + " / 5"),  
                   map(function(i){
                           var a = A({'title': i + " / 5", 'class': 'score-' + i}, i);
                           connect(a, 'onclick', function(){doValueShotScore5(a, i)});
                           return LI(null, a)
                       },
                       [1, 2, 3, 4, 5]));
    replaceChildNodes(vis, score)
}

/* ******************** */

displayValue = new Array();
valueEditor = new Array();

displayValue['text'] = DisplayValueText;
valueEditor['text'] = ValueEditorStringOrText;
displayValue['string'] = DisplayValueText;
valueEditor['string'] = ValueEditorStringOrText;
displayValue['score5'] = DisplayValueScore5;

function DisplayValue(vis, type, value){
    f = displayValue[type];
    if(f != undefined) f(vis, type, value);
}

function ValueEditor(vis, type, value){
    f = valueEditor[type];
    if(f != undefined) f(vis, type, value);
}

// return TD
function ValueValue(item){
    return findChildElements(item, ['.valueval'])[0]
}

// return text
function ValueType(item){
    return findChildElements(item, ['.valuetype'])[0].innerHTML
}

// return DOM
function ValueVis(item){
    return findChildElements(item, ['.valuevis'])[0]
}

EditValue = null;

function doEditValue(){
    if (InEditor()) return;
    //var value = dequote(ValueValue(this).innerHTML);
    var type = ValueType(this);
    ValueEditor(ValueVis(this),
        type,
        ValueValue(this).value)
}

function doValueFix1(){
    var value = findChildElements(EditValue, ['textarea'])[0].value;
    var qv = quote(value);
    ValueValue(EditValue.parentNode).value = qv;
    DisplayValue(EditValue, ValueType(EditValue.parentNode), qv);
    EditValue = null
}

function EntryToJSON(){
    return map(function(fldn){
                   return {'name': fldn.innerHTML,
                           'values':
                            map(function(fldv){
                                    return {'name': findChildElements(fldv, ['.valuename'])[0].innerHTML,
                                            'type': findChildElements(fldv, ['.valuetype'])[0].innerHTML,
                                            'value': findChildElements(fldv, ['.valueval'])[0].value
                                           }
                                },
                                findChildElements(fldn.parentNode, ['.val-value']))
                          }
               },
               findChildElements($('entFields'), ['.fld-name']))
}

function doSave(){
    if($('entCreateNew').checked){
        $('entId').value = "";
        $('entRev').value = "";
        $('entCreateNew').checked = false;
    }
    var json = {
	"module": "entry",
	"action": "save",
	"data": {
	    "id": $('entId').value,
	    "rev": $('entRev').value,
            "destination": "drafts",
            "fields": EntryToJSON()
	}
    }
    ajax(json, "/enge");
}

function cbEntSaved(json){
    log("entry saved: " + JSON.stringify(json))
    statusM(json.reply.action);
    $('entId').value = json.reply.id;
    $('entRev').value = json.reply.rev
}

// XXX set cursor to the end of text
function setupEditor(elt, value) {
    try{ tinyMCE.remove(tinyMCE.get(elt)) }catch(err){ null };

    tinyMCE.init({
        mode : "exact",
        elements: elt,
        theme : "advanced",
        plugins : "safari,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",
        //theme_advanced_buttons1 : "formatselect,|,bold,italic,underline,strikethrough,forecolor,backcolor,|,bullist,numlist,|,justifyleft,justifycenter,justifyright,justifyfull,outdent,indent,blockquote,|,link,unlink,|,paste,pastetext,pasteword,|,undo,redo",
        theme_advanced_buttons1 : "bold,italic,underline,strikethrough,forecolor,backcolor,|,bullist,numlist,|,blockquote,|,link,unlink,|,paste,pastetext,pasteword,|,undo,redo",
        theme_advanced_buttons2 : "",
        theme_advanced_buttons3 : "",
        theme_advanced_buttons4 : "",
        theme_advanced_toolbar_location : "top",
        theme_advanced_toolbar_align : "left",
        theme_advanced_statusbar_location : "bottom",
        theme_advanced_resizing : true,
        auto_resize: true,
        content_css : "css/tinymce.css",
        init_instance_callback: function(ed){
            ed.setContent(value);
            ed.execCommand('mceFocus');
        }

    })
}

connect('entSave', 'onclick', doSave);
connect('entCancel', 'onclick', doCancel);
connect('entNew', 'onclick', doApplyTemplate);
connect('entFieldAdd', 'onclick', doAddField);

connect(xapi, 'entry:entry_templates-ok', cbEntryTemplates);
connect(xapi, 'entry:value_names-ok', cbValueNames);
connect(xapi, 'entry:template-ok', cbEntTemplate);
connect(xapi, 'entry:read-ok', cbEntEdit);
connect(xapi, 'entry:save-ok', cbEntSaved);

connect(xapi, 'logged', requestTemplates);
</script>
