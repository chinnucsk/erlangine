<!-- destinations tree select, mark active, show/edit info and access lists -->
<div class=toolbar>
    <a id="destSearch" class=button>Search</a>
    <a id=destSave class=gbutton>Save</a>
    <a id=destDelete class=gbutton>Delete</a>
    <div id=destNew title="Destination name to create in current">
	<a id=destCreate class=gbutton>New destination</a>
	<label for=destNewName>Name</label>
	<input id=destNewName type=text />
    </div>
</div>
<div id=destList></div>
<div id=destEdit>
    <input id=destId type=hidden />
    <table>
	<tr><td><label for=destName>Destination</label>
	</td><td><input id=destName type=text /></td></tr>
	<tr><td><label for=destAnno>Annotation</label>
	</td><td><input id=destAnno type=text /></td></tr>
	<tr><td><label for=destSubscribeType>Subscription allowed for:</label>
	</td><td><select id=destSubscrType type=select>
	    <option value=full>Entire posts</option>
	    <option value=anno>Post Annotations</option>
	    <option value=none>None</option>
	</select></td></tr>
	<tr><td><label for=destReadApproved title="can read from external">Access approved:</label>
	</td><td><span id=destReadApproved>no data</span></td></tr>
	<tr><td><label for=destPostApproved title="can post to external">Post approved:</label>
	</td><td><span id=destPostApproved>no data</span></td></tr>
	<tr><td><label for=destSubscrApproved title="subscribed">Subscription approved:</label>
	</td><td><span id=destSubscrApproved>no data</span></td></tr>
	<tr><td><label for=destSubscribeType>Subscription:</label>
	</td><td><select id=destSubscrType type=select>
	    <option value=none>None</option>
	    <option value=anno>Post Annotations</option>
	    <option value=full>Entire posts</option>
	</select></td></tr>
	<tr><td><label for=xxx>Readers:</label></td></tr>
	<tr><td><label for=xxx>Writers:</label></td></tr>
	<tr><td><label for=xxx>Subscribers:</label></td></tr>
	<tr><td><label for=xxx>New requests:</label></td></tr>
    </table>
</div>

<script>

var destTestJSON = [
{'id': 'owndest',
 'name': 'Own destination',
 'anno': 'Top level account destinations',
 'childs': []},
];

function selectDest(){
    removeElementClass(selDest,'xtreeItemSelected');
    selDest = this.id;
    addElementClass(this,'xtreeItemSelected');
}

function doDestSearch(){
    initRootDests();
    var json = {
	"module": "dest",
	"action": "destinations",
	"data": {
	}
    }
    ajax(json, "/enge");
}

function parse_dest(dest){
    var d = dest.split("dest_", 2);
    return d[1]
}

function doDestCreateNode(){
    var json = {
	"module": "dest",
	"action": "new",
	"data": {
	    "parent": parse_dest(selDest),
	    "title": $('destNewName').value,
	    "anno": ""
	}
    }
    ajax(json, "/enge");
}

function doDestDeleteNode(){
    var json = {
	"module": "dest",
	"action": "remove",
	"data": {
	    "id": selDest
	}
    }
    ajax(json, "/enge");
}

function cbDestCreateNode(json){
    var node = xtreeCreateNode({'id': "dest_" + json.reply.id, 'name': json.reply.title, 'anno': json.reply.anno, 'childs': []});
    xtreeActivate(node, selectDest);
    xtreeInsertNode("dest_" + json.reply.parent, node);
}

function initRootDests(){
    var L = map(function(opt){
		    log("root: " + opt.value);
		    return {'id': "dest_" + opt.value,
			    'name': opt.value,
			    'anno': 'Your account',
			    'childs': []
			   }
		},
	    findChildElements($('loggedUid'), ['option']));
    xtreeCreateStruct('destList', L, selectDest);

    selDest = "dest_" + $('loggedUid').value;
    addElementClass(selDest, 'xtreeItemSelected');
}

connect('destSearch', 'onclick', doDestSearch);
connect('destCreate', 'onclick', doDestCreateNode);
connect('destDelete', 'onclick', doDestDeleteNode);
connect(xapi, 'dest:new-ok', cbDestCreateNode);

</script>
